# Users

## Account creation

<details>
<summary>
<code>/users/register</code>
</summary>

### Entrypoint

`POST /users/register`

### Parameters

- `request`: The HTTP request object containing the POST data.

Example request body:

> ``` javascript
> {
>     "username": "Damien1975",
>     "email": "damien.bokus@gmail.com",
>     "password": "Validpass7*"
> }
> ```

#### Parameters notes :
- All fields are mandatory.
- Username must be unique and between 3 and 25 characters long and cannot contains `"+/*.,!#%^&\{}[]=:;'"~"`.
- Email must be unique, valid and between 3 and 50 characters long.
- Password must be between 9 and 50 characters long, contain at least 1 lowercase character, 1 uppercase character, 1 number and 1 special character (`"+/*.,!#%^&\{}[]=:;'"~"`).

### Returns

- A JSON response indicating the success or failure of the registration process.

#### Success

If the authentication is successful, the server responds with a JSON object containing a `status` field with the value `"success"` and a `200 OK` HTTP status code.

#### Errors

- **JSON Decoding**: The function attempts to decode the request body into a Python dictionary. If the JSON is invalid, it returns a `406 Not Acceptable` response with an error message.

- **Email Uniqueness Check**: It checks if the provided email is unique using the `check_if_email_is_unique` function. If the email is already in use, it returns a `400 Bad Request` response with an error message.

- **Form Validation**: The function uses a `CustomUserCreationForm` to validate the incoming data. If the form is invalid, it returns a `400 Bad Request` response with the form errors.

### Notes

- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `CustomUserCreationForm` is a Django form that validates user registration data.

</details>

## Account connection
<br>
<details>
<summary>
<code>/users/login</code>
</summary>

### Entrypoint

`POST /users/login`

### Parameters

The `login` view accepts a POST request with a JSON body containing the following parameters:

- `username`: The username of the user attempting to log in.
- `password`: The password of the user attempting to log in.

Example request body:

> ``` javascript
> {
>     "username": "Damien1975",
>     "password": "Validpass7*"
> }
> ```


### Returns

The `login` view returns a JSON response indicating the success or failure of the authentication attempt.

#### Success

If the authentication is successful, the server responds with a JSON object containing a `status` field with the value `"success"` and a `200 OK` HTTP status code.

#### Errors

- **Invalid JSON format**: If the request body cannot be parsed as JSON, the server responds with a JSON object containing an `errors` field with the value `"Invalid JSON format"` and a `406 Not Acceptable` HTTP status code.

- **Authentication failure**: If the provided username and password do not match any user in the database, the server responds with a JSON object containing an `error` field with the value `"error"` and a `400 Bad Request` HTTP status code.

### Notes

- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- This view uses the built-in function `auth_login`.

</details>

<br>
<details>
<summary>
<code>/users/logout</code>
</summary>

### Entrypoint

`POST /users/logout`

### Parameters

The `logout` view accepts a POST request.

### Returns

The `logout` view returns a JSON response indicating the success of the logout attempt.

#### Success

If the authentication is successful, the server responds with a JSON object containing a `status` field with the value `"success"` and a `200 OK` HTTP status code.

### Notes

- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- This view uses the built-in function `logout`.

</details>

## Utils
<details>
<summary>
<code>/users/get_csrf_token</code>
</summary>
<br>
This function is used to retrieve the Cross-Site Request Forgery (CSRF) token for the current session and return it in a JSON response. A CSRF (Cross-Site Request Forgery) token is a security measure used to protect web applications from CSRF attacks. It is a secret, user-specific token that is included in all form submissions and side-effect URLs to prevent unauthorized actions from being performed on behalf of the user. The token is generated by the server and sent to the client, typically embedded within the HTML form as a hidden field. 

### Entrypoint

`GET /users/get_csrf_token`

### Parameters
- `request`: The HTTP request object.

### Returns
The CSRF token is returned in a JSON response with the key "csrfToken" and a `200 OK` HTTP status code.

### Notes

- The `@require_http_methods(["GET"])` decorator ensures that the view only accepts HTTP GET requests. Other request methods will result in a "Method Not Allowed" response.
- The `@ensure_csrf_cookie decorator` ensures that a CSRF cookie is included in the response.
- Inside the function, `get_token(request)` is a function that retrieves or generates a CSRF token.


- In any template that uses a POST form, use the csrf_token tag inside the `<form>` element if the form is for an internal URL, e.g.:

`<form method="post">{% csrf_token %}`

- **WARNING : This should not be done for POST forms that target external URLs, since that would cause the CSRF token to be leaked, leading to a vulnerability.**

</details>
<br>

<details>
<summary>
<code>/users/email_available</code>
</summary>
<br>

This util function is used to check if a email is available or not.

### Entrypoint

`GET /users/email_available`

### Parameters
- `request`: The HTTP request object.
- `email` : The email we want to check

### Returns
- Return `success` if the email is available and a 200 status code.
- Return `failure` if the email is already used and a 400 status code.
- Return also `Missing email` if the email is missing and a 400 status code.

### Notes
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 

</details>
<br>

<details>
<summary>
<code>/users/username_available</code>
</summary>
<br>

This util function is used to check if a username is available or not.

### Entrypoint

`GET /users/username_available`

### Parameters
- `request`: The HTTP request object.
- `username` : The username we want to check

### Returns
- Return `success` if the username is available and a 200 status code.
- Return `failure` if the username is already used and a 400 status code.
- Return also `Missing username` if the username is missing and a 400 status code.

### Notes
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 

</details>

## Users management

<details>
<summary>
<code>/users/get_user_datas</code>
</summary>
<br>

This function is used to retrieve data from the currently logged-in user. It returns the following information:
- username
- email
- bio
- title
- winrate
- rank
- number of games played

### Entry point
`GET /users/get_user_datas`

### Parameters
- `request`: The HTTP request object containing the GET data.

### Returns
- `success` and a dictionnary with all datas.

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 
</details>
<br>

<details>
<summary>
<code>/users/update_profile_bio</code>
</summary>
<br>

This function is used to change the bio of the currently logged-in user.

### Entrypoints
`POST /users/update_profile_bio`

### Parameters
- `request`: The HTTP request object containing the POST data.
- `bio`: the updated bio.

### Returns
- `"Your bio has been correctly updated !"` and a 200 status code if the bio was correctly updated.
- A 400 status code if the bio is either too long or missing.

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 

</details>
<br>

<details>
<summary>
<code>/users/update_email</code>
</summary>
<br>

This function is used to change the email of the currently logged-in user.

### Entrypoints
`POST /users/update_email`

### Parameters
- `request`: The HTTP request object containing the POST data.
- `email`: the updated email.

### Returns
- `"Your email has been correctly updated !"` and a 200 status code if the email was correctly updated.
- A 400 status code if the email send by the user is **not valid, already used or missing**.

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 

</details>
<br>

<details>
<summary>
<code>/users/update_profile_password</code>
</summary>
<br>

This function is used to change the password of the currently logged-in user.

### Entrypoints
`POST /users/update_profile_password`

### Parameters
- `request`: The HTTP request object containing the POST data.
- `new_password1`: the updated password.
- `new_password2`: the second updated password, to check if both are the same.

### Returns
- `"Your password has been correctly updated !"` and a 200 status code if the password was correctly updated.
- A 400 status code if passwords do not match or if one password is missing.

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view. 
- This view uses the built-in fonction `make_password` that converts a plain-text password into a hash that is appropriate for storing in a persistent database.

</details>
<br>

<details>
<summary>
<code>/users/update_profile_picture</code>
</summary>
<br>

This function is used to change the picture of the currently logged-in user.

### Entrypoints
`POST /users/update_profile_password`

### Parameters
- `request`: The HTTP request object containing the POST data.
- `image`: the new profile picture.

### Returns
- `"Your profile picture has been correctly updated !"` and a 200 status code if the profile picture was correctly updated.
- A 400 status code if :
    - the extension is invalid (it has to be `.jpg` or `.png`)
    - the image size exceeds the limit (max is 5MB)
    - there is no file provided
    - the file is invalid
    - dimensions are to large
    - or if there is an unexpected error while updating the profile picture

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view.
- The view uses the `magic` library to determine the file's MIME type from the first 1024 bytes then, checks if the file is an image by verifying that 'image' is in the MIME type.

</details>
<br>

<details>
<summary>
<code>/users/update_username</code>
</summary>
<br>

This function is used to change the username of the currently logged-in user.

### Entrypoints
`POST /users/update_username`

### Parameters
- `request`: The HTTP request object containing the POST data.
- `username`: the updated username.

### Returns
- `"Your username has been correctly updated !"` and a 200 status code if the username was correctly updated.
- A 400 status code if the username send by the user is **already used or missing**.

### Notes
- This function is decorated with `@login_required` to ensure that the user in correctly login.
- This function is decorated with `@require_http_methods(["POST"])` to ensure that it only accepts POST requests.
- The `@requires_csrf_token` decorator is used to enforce CSRF protection on the view.

</details>